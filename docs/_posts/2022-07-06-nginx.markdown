---
layout: post
title:  "Nginx配置实践"
date:   2022-07-06 17:10:11 +0800
categories: nginx
---
## websocket 代理配置

### 基础写法

```config
server {
  listen       8000;
  server_name  localhost;

  location / {
    root   D:/web/;
    index  index.html;
    try_files $uri $uri/ /index.html;
  }
  # websocket 代理
  location /websocket/ {
    proxy_pass http://192.168.0.100:3000/;
    proxy_set_header Host $host; 
    proxy_set_header X-Real-IP $remote_addr; 
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    proxy_http_version 1.1;
    # 连接成功后等待服务器响应时长，默认为60s
    proxy_read_timeout   3600s;
    # 关键：启用支持websocket连接
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }
  # 其他代理
  location /stage-api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Real-Port $remote_port;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://192.168.0.100:3000/;
  }

  error_page   500 502 503 504  /50x.html;
  location = /50x.html {
    root   html;
  }
}
```

**注意：在前端代码中的websocket请求地址，要用当前访问的url中host。否则不会被nginx代理**
```javascript
const url = `ws:${window.location.host}/websocket/chat`
const websocket = new Websocket(url)
```

> [Nginx官网](http://nginx.org/en/docs/http/websocket.html).
